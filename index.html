<!doctype html>
<html>
<head>
<title>Artist Birthday Search</title>
</head>
<body>
<input type="text" placeholder="Name" id="name" /> <button id="submit">Get Birthday</button>
<p><span id="birthday"></span></p>
<p><span id="artist"></span></p>
<p><span id="genres"></span></p>
<p><span id="link"></span></p>
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script>
	/* When submitting a name, format it correctly */
	var submitButton = document.getElementById("submit");
	submitButton.addEventListener("click",formatName);
	
	function formatName() {
		var input = document.getElementById("name");
		var name = input.value;
		var formattedName = name.split(' ').join('+');
		getArtistId(formattedName);
	}
	
	/* Use Wikidata entity search to get the ID for this artist */

	function getArtistId(formattedName) {
		var requestURL = 'https://www.wikidata.org/w/api.php?action=wbsearchentities&search=' + formattedName + '&language=en&format=json&limit=1';
		
		$.ajax({
		  method: "GET",
		  url: requestURL,
		  dataType: "jsonp",
		  success: function(data) {
		  //the artist's entity ID
		  if (data.search[0] !== undefined) {
			var id = data.search[0].id;
			console.log(id);
			getArtist(id);
			} else {
				alert("Can't find that person");
			}
			
		  }
		});
	}
	
	/* Use Wikidata to get that artist's data using their ID */
	
	function getArtist(id) {
		var requestURL = 'http://www.wikidata.org/wiki/Special:EntityData/' + id;
		
		$.ajax({
		  method: "GET",
		  url: requestURL,
		  success: function(data) {
			console.log("Success!");
			/* Go through the data and find the birth date (P569) */
			if (data.entities[id].claims.P569 !== undefined) {
			var birthday = data.entities[id].claims.P569[0].mainsnak.datavalue.value.time;
				printBirthday(birthday);
			} else {
				var text = document.getElementById("birthday");
		
				text.textContent = "Birthday Unknown";
			}
			/* Spotify ID (P1902) */
			if (data.entities[id].claims.P1902 === undefined) {
				console.log("no spotify");
				var nameText = document.getElementById("artist").textContent = "Spotify Unknown";
				var genresText = document.getElementById("genres").textContent = "";
				var linkText = document.getElementById("link").textContent = "";
			} else {
			var spotify = data.entities[id].claims.P1902[0].mainsnak.datavalue.value;

				console.log(spotify);

				getSpotify(spotify);
			}
		  }
		});
	}
	
	/* Display the birthday */
	function printBirthday(birthday) {
		var text = document.getElementById("birthday");
		
		text.textContent = "Born: " + birthday;
	}
	
	function getSpotify(id) {
		var requestURL = "https://api.spotify.com/v1/artists/" + id;
		
		$.ajax({
		  method: "GET",
		  url: requestURL,
		  success: function(data) {
		  /* Spotify artist info */
			var name = data["name"];
			console.log(name);
			var genres = data["genres"];
			var link = data["external_urls"]["spotify"];
			var nameText = document.getElementById("artist").textContent = name;
			var genresText = document.getElementById("genres").textContent = genres;
			var linkText = document.getElementById("link").textContent = link;
		  }
		});
		
	}
</script>
</body>
</html>